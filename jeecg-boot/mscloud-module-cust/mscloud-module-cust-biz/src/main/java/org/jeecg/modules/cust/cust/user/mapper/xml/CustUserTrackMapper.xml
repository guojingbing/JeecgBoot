<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.jeecg.modules.cust.cust.user.mapper.CustUserTrackMapper">
    <select id="getCustUserTracks" resultType="java.util.HashMap">
        SELECT
            u.phone_number,
            u.user_name,
            tmp.*
        FROM
            (
            SELECT
            t.*,
            (
            2 * 6378.137 * ASIN(
            SQRT(
            POW( SIN( PI( ) * ( #{lng}- loc_lng ) / 360 ), 2 ) + COS( PI( ) * #{lat} / 180 ) * COS( loc_lat * PI( ) / 180 ) * POW( SIN( PI( ) * ( #{lat}- loc_lat ) / 360 ), 2 )
            )
            )
            ) AS distance
            FROM cust_user_track t
            WHERE id IN (
                SELECT max( id ) FROM cust_user_track
                WHERE 1=1
                <if test="adcode!=null">
                    AND adcode like '${adcode}%'
                </if>
                <if test="afterDate!=null">
                    AND date(loc_time) > #{afterDate}
                </if>
                <if test="lng!=null and lat!=null">
                    AND #{radius} > (
                    2 * 6378.137 * ASIN(
                    SQRT(
                    POW( SIN( PI( ) * ( #{lng}- loc_lng ) / 360 ), 2 ) + COS( PI( ) * #{lat} / 180 ) * COS( loc_lat * PI( ) / 180 ) * POW( SIN( PI( ) * ( #{lat}- loc_lat ) / 360 ), 2 )
                    )
                    )
                    )
                </if>
                GROUP BY user_id )
            ) tmp
            LEFT JOIN cust_user u ON tmp.user_id = u.id
            WHERE 1=1
            <if test="appid!=null">
                AND u.appid = #{appid}
            </if>
        ORDER BY tmp.loc_time DESC
    </select>
</mapper>